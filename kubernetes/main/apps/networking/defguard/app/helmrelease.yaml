---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app defguard
spec:
  interval: 30m
  chart:
    spec:
      chart: defguard
      version: 0.8.0
      sourceRef:
        kind: HelmRepository
        name: defguard
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    image:
      repository: ghcr.io/defguard/defguard
      tag: 1.0.0@sha256:3bb3fa074a7e87f81e7b512e338b48fae94632855ad59e47eecedfd4da533781
    existingJwtSecret: defguard-secret
    publicUrl: "https://defguard.${SECRET_DOMAIN}"
    ingress:
      grpc:
        className: traefik-external
        annotations:
          external-dns.alpha.kubernetes.io/target: "ipv4.${SECRET_DOMAIN}"
          external-dns.alpha.kubernetes.io/exclude-unifi: "true"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-traefik-middleware-chain-no-rate-limit@kubernetescrd"
        host: &grpc "defguard-grpc.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *grpc
            secretName: "${SECRET_DOMAIN/./-}-production-tls"
      web:
        className: traefik-external
        annotations:
          external-dns.alpha.kubernetes.io/target: "ipv4.${SECRET_DOMAIN}"
          external-dns.alpha.kubernetes.io/exclude-unifi: "true"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-traefik-middleware-chain-no-rate-limit@kubernetescrd"
        host: &host "defguard.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *host
            secretName: "${SECRET_DOMAIN/./-}-production-tls"
    postgresql:
        enabled: false
        host: postgres-pgbouncer.database.svc.cluster.local
        port: 5432
        auth:
          database: defguard_db
          username: defguard
          existingSecret: defguard-db-secret
          existingSecretPasswordKey: DEFGUARD_DB_PASSWORD
