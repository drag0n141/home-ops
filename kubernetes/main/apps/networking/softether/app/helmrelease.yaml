---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app softether
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      softether:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: docker.io/softethervpn/vpnserver
              tag: latest@sha256:0afc37232286a640e9d95233cd948248449796d977e9f5d234df81b7e70a34aa
            env:
              TZ: ${TIMEZONE}
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                add: ["NET_ADMIN"]
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 512Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        forceRename: *app
        primary: true
        ports:
          http:
            port: 443
      vpn:
        type: LoadBalancer
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "vpn.${SECRET_DOMAIN_INTERNAL}"
          lbipam.cilium.io/ips: 192.168.222.240
        ports:
          dns:
            port: 53
            protocol: TCP
          ovpn:
            port: 1194
            protocol: UDP
    persistence:
      data:
        existingClaim: *app
        globalMounts:
          - path: /var/lib/softether
      adminip:
        type: configMap
        name: softether-configmap
        globalMounts:
          - path: /var/lib/softether/adminip.txt
            subPath: adminip.txt
            readOnly: true
      tls:
        type: secret
        name: "${SECRET_DOMAIN/./-}-production-tls"
        defaultMode: 0400
        globalMounts:
          - subPath: tls.crt
            path: /tls/tls.crt
            readOnly: true
          - subPath: tls.key
            path: /tls/tls.key
            readOnly: true
      tmpfs:
        type: emptyDir
        advancedMounts:
          softether:
            app:
              - path: /var/log/softether
                subPath: logs
              - path: /run/softether
                subPath: run
              - path: /tmp
                subPath: tmp
