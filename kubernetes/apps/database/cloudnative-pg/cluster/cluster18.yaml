---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: "enabled"
spec:
  instances: 3
  # renovate: datasource=docker depName=ghcr.io/cloudnative-pg/postgresql
  imageName: ghcr.io/cloudnative-pg/postgresql:18.1-standard-trixie@sha256:2fc5696eb0b684921f7d976b134e9c2419313aa4bbf8b1d79f8591b452787792
  primaryUpdateStrategy: unsupervised
  storage:
    size: 15Gi
    storageClass: openebs-hostpath
  superuserSecret:
    name: cloudnative-pg-secret
  enableSuperuserAccess: true
  postgresql:
    parameters:
      max_connections: "400"
      shared_buffers: 512MB
  resources:
    requests:
      cpu: 500m
    limits:
      hugepages-2Mi: 2Gi
      memory: 4Gi
  monitoring:
    enablePodMonitor: true
  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters: &parameters
        barmanObjectName: garage
        serverName: postgres
  externalClusters:
#    - name: source
#      plugin:
#        name: barman-cloud.cloudnative-pg.io
#        parameters: *parameters
    - name: &oldCluster postgres17
      connectionParameters:
        host: postgres17-rw.database.svc.cluster.local
        user: postgres
        dbname: postgres
        sslmode: require
      password:
        name: cloudnative-pg-secret
        key: password
  bootstrap:
#    recovery:
#      source: source
    initdb:
      import:
        type: monolith
        databases: ["atuin_db", "authelia_db", "authentik_db", "autopulse_db", "ferdium_db", "gamevault_db", "ganymede_db", "gatus_db", "gitea_db", "gotify_db", "grafana_db", "guacamole_db", "jellyseerr_db", "kitchenowl_db", "lidarr_main", "linkding_db", "mas_db", "mautrixdiscord_db", "mautrixwhatsapp_db", "memos_db", "miniflux_db", "n8n_db", "netbox_db", "netronome_db", "nextcloud_db", "openarchiver_db", "openwebui_db", "outline_db", "paperless_db", "pocketid_db", "prowlarr_main", "pulsarr_db", "radarr4k_main", "radarr_main", "recipes_db", "romm_db", "shlink_db", "sonarr4k_main", "sonarr_main", "sonarrkids_main", "synapse_db", "ts3_db", "vaultwarden_db", "vikunja_db", "wgportal_db", "wiki_db", "youtarr_db", "zipline_db"]
        roles: ["atuin", "authelia", "authentik", "autopulse", "ferdium", "gamevault", "ganymede", "gatus", "gitea", "gotify", "grafana", "guacamole", "immich", "jellyseerr", "kitchenowl", "lidarr", "linkding", "mas", "mautrixdiscord", "mautrixwhatsapp", "memos", "miniflux", "n8n", "netbox", "netronome", "nextcloud", "openarchiver", "openwebui", "outline", "paperless", "pocketid", "prowlarr", "pulsarr", "radarr", "radarr4k", "recipes", "romm", "shlink", "sonarr", "sonarr4k", "sonarrkids", "synapse", "ts3", "vaultwarden", "vikunja", "wgportal", "wiki", "youtarr", "zipline"]
        source:
          externalCluster: *oldCluster
