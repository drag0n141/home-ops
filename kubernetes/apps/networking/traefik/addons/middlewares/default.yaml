---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-error-pages
  namespace: networking
spec:
  errors:
    status:
      - "400-400"
      - "402-402"
      - "404-599"
    query: /{status}.html
    service:
      name: error-pages
      port: 8080
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-cloudflare-ips
  namespace: networking
spec:
  ipWhiteList:
    sourceRange:
      - 173.245.48.0/20
      - 103.21.244.0/22
      - 103.22.200.0/22
      - 103.31.4.0/22
      - 141.101.64.0/18
      - 108.162.192.0/18
      - 190.93.240.0/20
      - 188.114.96.0/20
      - 197.234.240.0/22
      - 198.41.128.0/17
      - 162.158.0.0/15
      - 104.16.0.0/13
      - 104.24.0.0/14
      - 172.64.0.0/13
      - 131.0.72.0/22
      - 2400:cb00::/32
      - 2606:4700::/32
      - 2803:f800::/32
      - 2405:b500::/32
      - 2405:8100::/32
      - 2a06:98c0::/29
      - 2c0f:f248::/32
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-only-local
  namespace: networking
spec:
  ipWhiteList:
    sourceRange:
      - 192.168.40.0/24
      - 192.168.41.0/24
      - 192.168.42.0/24
      - 192.168.140.0/24
      - 192.168.230.0/24
      - 192.168.240.0/24
      - 192.168.250.0/24
      - 192.168.254.0/24
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-github-hooks-ips
  namespace: networking
spec:
  ipWhiteList:
    # https://api.github.com/meta
    sourceRange:
      - 192.30.252.0/22
      - 185.199.108.0/22
      - 140.82.112.0/20
      - 143.55.64.0/20
      - 2a0a:a440::/29
      - 2606:50c0::/32
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-rate-limit
  namespace: networking
spec:
  rateLimit:
    average: 100
    burst: 50
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-secure-headers
  namespace: networking
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - OPTIONS
      - PUT
      - POST
    accessControlMaxAge: 100
    hostsProxyHeaders:
      - "X-Forwarded-Host"
      - "X-Forwarded-For"
      - "X-Forwarded-Proto"
      - "X-GEO-City"
      - "Cf-Connecting-Ip"
      - "Cf-Ipcountry"
    stsSeconds: 31536000
    stsIncludeSubdomains: false
    stsPreload: true
    forceSTSHeader: true
    customFrameOptionsValue: "allow-from https:${SECRET_DOMAIN}"
    contentTypeNosniff: true
    browserXssFilter: true
    frameDeny: true
    referrerPolicy: "same-origin"
    contentSecurityPolicy: "upgrade-insecure-requests;"
    customResponseHeaders:
      permissionsPolicy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
      X-Frame-Options: "SAMEORIGIN"
      X-Robots-Tag: "none,noindex,nofollow,noarchive,nosnippet,notranslate,noimageindex"
      X-Permitted-Cross-Domain-Policies: "none"
      X-Forwarded-Proto: "https"
      City: X-GEO-City
      server: ""
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-compress
  namespace: networking
spec:
  compress:
    minResponseBodyBytes: 1024
    excludedContentTypes:
      - application/zip
      - application/octet-stream
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-authelia
  namespace: networking
spec:
  forwardAuth:
    address: http://authelia.networking.svc.cluster.local:9091/api/verify?rd=https%3A%2F%2Fauthelia.${SECRET_DOMAIN}%2F
    trustForwardHeader: true
    authResponseHeaders:
      - Remote-User
      - Remote-Groups
      - Remote-Name
      - Remote-Email
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-authentik
  namespace: networking
spec:
  forwardAuth:
    address: http://authentik-proxy.networking.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik
    trustForwardHeader: true
    authResponseHeaders:
      - X-authentik-username
      - X-authentik-groups
      - X-authentik-email
      - X-authentik-name
      - X-authentik-uid
      - X-authentik-jwt
      - X-authentik-meta-jwks
      - X-authentik-meta-outpost
      - X-authentik-meta-provider
      - X-authentik-meta-app
      - X-authentik-meta-version
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-chain-no-auth
  namespace: networking
spec:
  chain:
    middlewares:
      - name: traefik-middleware-rate-limit
      - name: traefik-middleware-secure-headers
      - name: traefik-middleware-compress
      - name: traefik-middleware-error-pages
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: traefik-middleware-chain-authelia
  namespace: networking
spec:
  chain:
    middlewares:
      - name: traefik-middleware-rate-limit
      - name: traefik-middleware-secure-headers
      - name: traefik-middleware-compress
      - name: traefik-middleware-error-pages
      - name: traefik-middleware-authelia
---
 apiVersion: traefik.containo.us/v1alpha1
 kind: Middleware
 metadata:
   name: traefik-middleware-chain-authentik
   namespace: networking
 spec:
   chain:
     middlewares:
      - name: traefik-middleware-rate-limit
      - name: traefik-middleware-secure-headers
      - name: traefik-middleware-compress
      - name: traefik-middleware-error-pages
      - name: traefik-middleware-authentik
