---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      openclaw:
        labels:
          nfsMount: "true"
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          install-tools:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.2.26@sha256:ce9347548afa0b6bdd1d262060535ba04baf0b19cde0fc211c8039492647d1b1
            command:
              - /bin/sh
              - -c
              - |
                set -e
                mkdir -p /home/node/.local/bin /home/node/.local/go

                echo "Starting tool installation..."

                # Install gh CLI if not present on PVC
                if [ ! -f /home/node/.local/bin/gh ]; then
                  echo "Installing gh CLI..."
                  cd /tmp
                  curl -fsSL https://github.com/cli/cli/releases/download/v2.61.0/gh_2.61.0_linux_amd64.tar.gz -o gh.tar.gz
                  tar xzf gh.tar.gz
                  cp gh_2.61.0_linux_amd64/bin/gh /home/node/.local/bin/
                  rm -rf gh.tar.gz gh_2.61.0_linux_amd64
                fi

                # Install Homebrew if not present on PVC
                if [ ! -f /home/node/.local/homebrew/bin/brew ]; then
                  echo "Installing Homebrew..."
                  export HOMEBREW_PREFIX=/home/node/.local/homebrew
                  export HOMEBREW_CELLAR=/home/node/.local/homebrew/Cellar
                  export HOMEBREW_REPOSITORY=/home/node/.local/homebrew
                  mkdir -p $HOMEBREW_PREFIX
                  cd /tmp
                  git clone --depth 1 https://github.com/Homebrew/brew $HOMEBREW_PREFIX
                fi

                # Check if pip is available (either standalone or via python3 -m pip)
                set +e # Don't fail on pip errors
                if command -v pip3 >/dev/null 2>&1 || command -v pip >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
                  echo "pip is available"
                else
                  echo "Installing pip..."
                  cd /tmp
                  curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
                  python3 get-pip.py --user --no-warn-script-location --break-system-packages || \
                  python3 get-pip.py --user --no-warn-script-location || \
                  echo "pip install skipped (use python3 -m pip instead)"
                  rm -f get-pip.py
                fi
                set -e # Re-enable error checking

                echo "Tool installation complete"

                # Ensure config directory exists
                mkdir -p /home/node/.openclaw
                echo "Init container completed successfully"
        containers:
          app:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.2.26@sha256:ce9347548afa0b6bdd1d262060535ba04baf0b19cde0fc211c8039492647d1b1
            command:
              - /bin/sh
              - -c
              - |
                # Set up openclawbot CLI symlink
                ln -sf /app/openclawbot.mjs /home/node/.local/bin/openclawbot
                # Start gateway
                exec node dist/index.js gateway --bind lan
            env:
              BROWSER_WS_ENDPOINT: "ws://localhost:3000/chrome?stealth=1&--disable-web-security=true"
              GOPATH: /home/node/go
              HOME: &homepath /home/node
              HOMEBREW_CELLAR: /home/node/.local/homebrew/Cellar
              HOMEBREW_PREFIX: /home/node/.local/homebrew
              HOMEBREW_REPOSITORY: /home/node/.local/homebrew
              OPENCLAW_GATEWAY_PORT: &port 18789
              PATH: /home/node/.local/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
              PIP_BREAK_SYSTEM_PACKAGES: "1"
              TERM: xterm-256color
              TZ: ${TIMEZONE}
            envFrom:
              - secretRef:
                  name: openclaw
            resources:
              requests:
                cpu: 50m
                memory: 512Mi
              limits:
                cpu: 2000m
                memory: 4Gi
          chrome:
            image:
              repository: ghcr.io/browserless/chrome
              tag: v2.42.0@sha256:af7b7069d2a00de431b0c0f5e51946bed3615b90cc4e35dc72d3f1b81b907bdf
            env:
              TZ: ${TIMEZONE}
              TIMEOUT: 60000
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 2Gi
          codeserver:
            image:
              repository: ghcr.io/coder/code-server
              tag: 4.109.2@sha256:1b84cd817fe8eb1159323ae9d2f29b3c70c6ccd44958d651a94900cf7f0ff9c4
            env:
              TZ: ${TIMEZONE}
            args:
              [
                "--auth",
                "none",
                "--user-data-dir",
                "/home/node/.vscode",
                "--extensions-dir",
                "/home/node/.vscode",
                "--port",
                "12321",
                "/config",
              ]
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 1Gi
    defaultPodOptions:
      shareProcessNamespace: true
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        ports:
          http:
            port: *port
          code-server:
            port: 12321
    route:
      app:
        forceRename: "{{ .Release.Name }}"
        annotations:
          gatus.home-operations.com/enabled: "false"
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN_INTERNAL}"
        parentRefs:
          - name: envoy-internal
            namespace: networking
        rules:
          - backendRefs:
              - identifier: app
                port: http
      code-server:
        annotations:
          gatus.home-operations.com/enabled: "false"
        hostnames:
          - "{{ .Release.Name }}-code.${SECRET_DOMAIN_INTERNAL}"
        parentRefs:
          - name: envoy-internal
            namespace: networking
        rules:
          - backendRefs:
              - identifier: app
                port: code-server
    rbac:
      roles:
        openclaw-read-all:
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["pods", "nodes", "services", "namespaces", "configmaps", "persistentvolumes", "persistentvolumeclaims", "endpoints", "resourcequotas", "limitranges", "serviceaccounts", "events"]  # Added events
              verbs: ["get", "list", "watch"]
            - apiGroups: [""]
              resources: ["pods/log"]
              verbs: ["get", "list"]
            - apiGroups: ["apps"]
              resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["batch"]
              resources: ["jobs", "cronjobs"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses", "networkpolicies"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["storage.k8s.io"]
              resources: ["storageclasses"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["rbac.authorization.k8s.io"]
              resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["metrics.k8s.io"]
              resources: ["nodes", "pods"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["helm.toolkit.fluxcd.io"]
              resources: ["helmreleases"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["kustomize.toolkit.fluxcd.io"]
              resources: ["kustomizations"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["external-secrets.io"]
              resources: ["externalsecrets"]
              verbs: ["get", "list", "watch"]
        openclaw-write-restricted:
          type: Role
          rules:
            - apiGroups: [""]
              resources: ["pods"]
              verbs: ["delete"]
            - apiGroups: ["batch"]
              resources: ["jobs"]
              verbs: ["delete"]
            - apiGroups: [""]
              resources: ["pods/exec"]
              verbs: ["create"]
            - apiGroups: ["apps"]
              resources: ["deployments"]
              verbs: ["patch", "update"]
      bindings:
        openclaw-read-all:
          type: ClusterRoleBinding
          roleRef:
            identifier: openclaw-read-all
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
        openclaw-write-restricted:
          type: RoleBinding
          roleRef:
            identifier: openclaw-write-restricted
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
    serviceAccount:
      openclaw: {}
    persistence:
      config:
        existingClaim: "{{ .Release.Name }}"
        globalMounts:
          - path: *homepath
      data:
        type: nfs
        server: nas01.${SECRET_DOMAIN_INT}
        path: /mnt/data/openclaw
        globalMounts:
          - path: /data
