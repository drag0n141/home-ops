---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app gitea
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: gitea
  values:
    strategy:
      type: Recreate
    image:
      registry: ghcr.io
      repository: go-gitea/gitea
      tag: 1.24.5
      rootless: true
    containerSecurityContext:
      capabilities:
        add: ["SYS_CHROOT"]
    gitea:
      admin:
        existingSecret: &secret gitea-secret
      config:
        APP_NAME: "Gitea DrAg0n141"
        database:
          DB_TYPE: postgres
          HOST: postgres17-rw.database.svc.cluster.local:5432
        server:
          SSH_PORT: 22
          SSH_LISTEN_PORT: 2222
          SSH_DOMAIN: git.${SECRET_DOMAIN_INTERNAL}
          ROOT_URL: https://gitea.${SECRET_DOMAIN_INTERNAL}
          LANDING_PAGE: explore
        respository:
          DEFAULT_BRANCH: main
          DEFAULT_PRIVATE: true
        admin:
          DISABLE_REGULAR_ORG_CREATION: true
        service:
          DISABLE_REGISTRATION: false
          ALLOW_ONLY_EXTERNAL_REGISTRATION: true
          DEFAULT_KEEP_EMAIL_PRIVATE: true
          SHOW_REGISTRATION_BUTTON: false
        cron:
          ENABLED: true
        storage:
          STORAGE_TYPE: minio
          MINIO_ENDPOINT: s3.${SECRET_DOMAIN_INTERNAL}
          MINIO_BUCKET: gitea
          MINIO_USE_SSL: true
        mailer:
          ENABLED: true
          PROTOCOL: smtp
          SMTP_ADDR: smtp-relay.networking.svc.cluster.local
          SMTP_PORT: 2525
          FROM: "Gitea <gitea@${SECRET_DOMAIN}>"
        cache:
          ADAPTER: redis
        queue:
          TYPE: redis
        session:
          PROVIDER: redis
        openid:
          ENABLE_OPENID_SIGNIN: false
          ENABLE_OPENID_SIGNUP: true
        oauth2_client:
          ENABLE_AUTO_REGISTRATION: true
          ACCOUNT_LINKING: auto
          USERNAME: preferred_username
          UPDATE_AVATAR: true
          OPENID_CONNECT_SCOPES: openid email profile groups
        other:
          SHOW_FOOTER_TEMPLATE_LOAD_TIME: false
        ui:
          SHOW_USER_EMAIL: false
        webhook:
          ALLOWED_HOST_LIST: "*.${SECRET_DOMAIN}"
      oauth:
        - name: PocketID
          provider: openidConnect
          existingSecret: *secret
          autoDiscoverUrl: https://id.${SECRET_DOMAIN}/.well-known/openid-configuration
          groupClaimName: groups
          adminGroup: ID-Admin
          restrictedGroup: ID-Gitea
          iconUrl: https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/pocket-id.png
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    postgresql:
      enabled: false
    postgresql-ha:
      enabled: false
    memcached:
      enabled: false
    valkey-cluster:
      enabled: false
    persistence:
      enabled: true
      create: false
      claimName: gitea
    service:
      ssh:
        type: LoadBalancer
        port: 22
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "git.${SECRET_DOMAIN_INTERNAL}"
          lbipam.cilium.io/ips: 192.168.222.125
    ingress:
      enabled: true
      className: traefik-internal
      annotations:
        external-dns.alpha.kubernetes.io/target: "internal.${SECRET_DOMAIN_INTERNAL}"
        traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
        traefik.ingress.kubernetes.io/router.middlewares: "networking-traefik-middleware-chain-no-auth@kubernetescrd"
      hosts:
        - host: &host "gitea.${SECRET_DOMAIN_INTERNAL}"
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host
          secretName: "${SECRET_DOMAIN/./-}-production-tls"
  valuesFrom:
    - targetPath: gitea.config.storage.MINIO_ACCESS_KEY_ID
      kind: Secret
      name: *secret
      valuesKey: GITEA_AWS_ACCESS_KEY_ID
    - targetPath: gitea.config.storage.MINIO_SECRET_ACCESS_KEY
      kind: Secret
      name: *secret
      valuesKey: GITEA_AWS_SECRET_ACCESS_KEY
    - targetPath: gitea.config.database.NAME
      kind: Secret
      name: *secret
      valuesKey: POSTGRES_DB
    - targetPath: gitea.config.database.USER
      kind: Secret
      name: *secret
      valuesKey: POSTGRES_USERNAME
    - targetPath: gitea.config.database.PASSWD
      kind: Secret
      name: *secret
      valuesKey: POSTGRES_PASSWORD
    - targetPath: gitea.config.cache.HOST
      kind: Secret
      name: *secret
      valuesKey: REDIS_URL
    - targetPath: gitea.config.queue.CONN_STR
      kind: Secret
      name: *secret
      valuesKey: REDIS_URL
    - targetPath: gitea.config.session.PROVIDER_CONFIG
      kind: Secret
      name: *secret
      valuesKey: REDIS_URL
    - targetPath: gitea.config.security.SECRET_KEY
      kind: Secret
      name: *secret
      valuesKey: GITEA_SECRET_KEY
    - targetPath: gitea.config.security.INTERNAL_TOKEN
      kind: Secret
      name: *secret
      valuesKey: GITEA_INTERNAL_TOKEN
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: gitea
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: gitea
              spec:
                template:
                  spec:
                    initContainers:
                      - name: 01-init-db
                        image: ghcr.io/home-operations/postgres-init:17
                        envFrom:
                          - secretRef:
                              name: gitea-secret
