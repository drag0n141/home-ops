apiVersion: openclaw.rocks/v1alpha1
kind: OpenClawInstance
metadata:
  name: &app openclaw-instance
spec:
  initContainers:
    - name: install-kubectl
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          KUBECTL_VERSION=$(curl -fsSL https://dl.k8s.io/release/stable.txt)
          MARKER="/home/openclaw/.openclaw/.local/bin/.kubectl-version"

          if [ ! -f /home/openclaw/.openclaw/.local/bin/kubectl ] || \
             [ ! -f "$MARKER" ] || \
             [ "$(cat $MARKER)" != "$KUBECTL_VERSION" ]; then
            echo "Installing kubectl $KUBECTL_VERSION..."
            apk add --no-cache curl
            curl -fsSL "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" \
              -o /home/openclaw/.openclaw/.local/bin/kubectl
            chmod +x /home/openclaw/.openclaw/.local/bin/kubectl
            echo "$KUBECTL_VERSION" > "$MARKER"
            echo "kubectl $KUBECTL_VERSION installed"
          else
            echo "kubectl $KUBECTL_VERSION already up to date, skipping"
          fi
      volumeMounts:
        - name: openclaw-instance
          mountPath: /home/openclaw/.openclaw
  envFrom:
    - secretRef:
        name: openclaw-secret
  config:
    raw:
      gateway:
        controlUi:
          allowedOrigins:
            - "https://openclaw.${SECRET_DOMAIN_INTERNAL}"
        trustedProxies:
          - "127.0.0.1"
          - "10.42.0.0/16"
      agents:
        defaults:
          model:
            primary: "openai/gpt-5.1-codex"
  chromium:
    enabled: true
    image:
      repository: ghcr.io/browserless/chrome
      tag: v2.42.0@sha256:af7b7069d2a00de431b0c0f5e51946bed3615b90cc4e35dc72d3f1b81b907bdf
    resources:
      requests:
        cpu: 10m
        memory: 250Mi
      limits:
        memory: 2000Mi
  networking:
    ingress:
      enabled: false
  security:
    networkPolicy:
      enabled: false
  storage:
    persistence:
      enabled: true
      existingClaim: *app
