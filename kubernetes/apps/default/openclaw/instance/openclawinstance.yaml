apiVersion: openclaw.rocks/v1alpha1
kind: OpenClawInstance
metadata:
  name: &app openclaw-instance
spec:
  initContainers:
    - name: install-tools
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          set -e
          mkdir -p /home/openclaw/.openclaw/.local/bin
          mkdir -p /home/openclaw/.openclaw/.local/homebrew

          # Install Homebrew if not present on PVC
          if [ ! -f /home/openclaw/.openclaw/.local/homebrew/bin/brew ]; then
            echo "Installing Homebrew..."
            apk add --no-cache curl git bash
            git clone --depth 1 https://github.com/Homebrew/brew \
              /home/openclaw/.openclaw/.local/homebrew
            echo "Homebrew installed"
          else
            echo "Homebrew already installed, skipping"
          fi
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      volumeMounts:
        - name: data
          mountPath: /home/openclaw/.openclaw
  env:
    - name: HOMEBREW_PREFIX
      value: /home/openclaw/.openclaw/.local/homebrew
    - name: HOMEBREW_CELLAR
      value: /home/openclaw/.openclaw/.local/homebrew/Cellar
    - name: HOMEBREW_REPOSITORY
      value: /home/openclaw/.openclaw/.local/homebrew
    - name: PATH
      value: /home/openclaw/.openclaw/.local/homebrew/bin:/home/openclaw/.openclaw/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  envFrom:
    - secretRef:
        name: openclaw-secret
  config:
    raw:
      gateway:
        controlUi:
          allowedOrigins:
            - "https://openclaw.${SECRET_DOMAIN_INTERNAL}"
        trustedProxies:
          - "127.0.0.1"
          - "10.42.0.0/16"
      agents:
        defaults:
          model:
            primary: "openai/gpt-5.1-codex"
  chromium:
    enabled: true
    image:
      repository: ghcr.io/browserless/chrome
      tag: v2.42.0@sha256:af7b7069d2a00de431b0c0f5e51946bed3615b90cc4e35dc72d3f1b81b907bdf
    resources:
      requests:
        cpu: 10m
        memory: 250Mi
      limits:
        memory: 2000Mi
  networking:
    ingress:
      enabled: false
  security:
    networkPolicy:
      enabled: false
  storage:
    persistence:
      enabled: true
      existingClaim: *app
