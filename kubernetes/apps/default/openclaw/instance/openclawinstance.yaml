apiVersion: openclaw.rocks/v1alpha1
kind: OpenClawInstance
metadata:
  name: &app openclaw-instance
spec:
  initContainers:
    - name: install-tools
      image: ghcr.io/openclaw/openclaw:latest
      command:
        - /bin/sh
        - -c
        - |
          set -e
          mkdir -p /home/openclaw/.openclaw/.local/bin
          mkdir -p /home/openclaw/.openclaw/.local/homebrew
          if [ ! -f /home/openclaw/.openclaw/.local/homebrew/bin/brew ]; then
            echo "Installing Homebrew..."
            git clone --depth 1 https://github.com/Homebrew/brew \
              /home/openclaw/.openclaw/.local/homebrew
            echo "Homebrew installed"
          else
            echo "Homebrew already installed, skipping"
          fi
          if [ ! -f /home/openclaw/.openclaw/.local/bin/gh ]; then
            echo "Installing gh CLI..."
            cd /tmp
            curl -fsSL https://github.com/cli/cli/releases/download/v2.61.0/gh_2.61.0_linux_amd64.tar.gz -o gh.tar.gz
            tar xzf gh.tar.gz
            cp gh_2.61.0_linux_amd64/bin/gh /home/openclaw/.openclaw/.local/bin/
            rm -rf gh.tar.gz gh_2.61.0_linux_amd64
          else
            echo "gh CLI already installed, skipping"
          fi
      volumeMounts:
        - name: data
          mountPath: /home/openclaw/.openclaw
  env:
    - name: HOMEBREW_PREFIX
      value: /home/openclaw/.openclaw/.local/homebrew
    - name: HOMEBREW_CELLAR
      value: /home/openclaw/.openclaw/.local/homebrew/Cellar
    - name: HOMEBREW_REPOSITORY
      value: /home/openclaw/.openclaw/.local/homebrew
    - name: PATH
      value: /home/openclaw/.openclaw/.local/homebrew/bin:/home/openclaw/.openclaw/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  envFrom:
    - secretRef:
        name: openclaw-secret
  config:
    raw:
      agents:
        defaults:
          model:
            primary: "minimax/MiniMax-M2.5"
            fallbacks:
              - "openai-codex/gpt-5.3-codex"
          maxConcurrent: 4
          timeoutSeconds: 300
          heartbeat:
            every: "30m"
            activeHours:
              start: "07:00"
              end: "23:00"
          contextPruning:
            mode: "cache-ttl"
            ttl: "6h"
            keepLastAssistants: 4
            softTrimRatio: 0.3
            hardClearRatio: 0.5
            minPrunableToolChars: 50000
            softTrim:
              maxChars: 4000
              headChars: 1500
              tailChars: 1500
            hardClear:
              enabled: true
              placeholder: "[Old tool result content cleared]"
            tools:
              deny:
                - "browser"
                - "canvas"
          compaction:
            mode: "safeguard"
            reserveTokensFloor: 24000
            memoryFlush:
              enabled: true
              softThresholdTokens: 12000
              prompt: "Extract key decisions, state changes, lessons, blockers to memory/YYYY-MM-DD.md. Format: ## [HH:MM] Topic. Skip routine work. NO_FLUSH if nothing important."
              systemPrompt: "Compacting session context. Extract only what's worth remembering. No fluff."
      channels:
        whatsapp:
          dmPolicy: "allowlist"
          allowFrom:
            - "$${WHATSAPP_PHONE_NUMBER}"
          groupPolicy: "allowlist"
          groupAllowFrom:
            - "$${WHATSAPP_PHONE_NUMBER}"
      plugins:
        entries:
          whatsapp:
            enabled: true
      session:
        dmScope: "per-channel-peer"
        maintenance:
          mode: "enforce"
          pruneAfter: "7d"
          maxEntries: 1000
          rotateBytes: "100mb"
          resetArchiveRetention: "7d"
      messages:
        responsePrefix: "[{provider}/{model}]"
      gateway:
        controlUi:
          allowedOrigins:
            - "https://openclaw.${SECRET_DOMAIN_INTERNAL}"
        trustedProxies:
          - "127.0.0.1"
          - "10.42.0.0/16"
  chromium:
    enabled: true
    image:
      repository: ghcr.io/browserless/chrome
      tag: v2.42.0@sha256:af7b7069d2a00de431b0c0f5e51946bed3615b90cc4e35dc72d3f1b81b907bdf
    resources:
      requests:
        cpu: 10m
        memory: 250Mi
      limits:
        memory: 2000Mi
  networking:
    ingress:
      enabled: false
  security:
    networkPolicy:
      enabled: false
  selfConfigure:
    enabled: true
  storage:
    persistence:
      enabled: true
      existingClaim: *app
